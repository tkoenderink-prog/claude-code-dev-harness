#!/usr/bin/env python3
# /// script
# requires-python = ">=3.9"
# dependencies = []
# ///

"""
SessionStart Hook
Runs when Claude Code session begins.
Injects state files AND checks harness version.
"""

import json
import sys
import os
import subprocess
from pathlib import Path
from datetime import datetime, timezone

def check_harness_version(project_dir):
    """
    Check for harness updates with caching.

    Returns:
        str: Update message if available, None otherwise
    """
    version_lock = project_dir / '.claude' / 'VERSION.lock'

    # Only check if VERSION.lock exists (harness installed)
    if not version_lock.exists():
        return None

    try:
        # Load config from VERSION.lock
        config = {}
        for line in version_lock.read_text().splitlines():
            if ':' in line:
                key, value = line.split(':', 1)
                config[key.strip()] = value.strip().strip('"')

        cache_dir = project_dir / '.claude-state' / 'harness' / 'remote-cache'
        cache_file = cache_dir / 'last-check.txt'

        # Check cache age
        should_check = True
        if cache_file.exists():
            try:
                last_check = int(cache_file.read_text().strip())
                now = int(datetime.now(timezone.utc).timestamp())
                age_hours = (now - last_check) / 3600
                cache_hours = int(config.get('cache_duration_hours', 6))

                if age_hours < cache_hours:
                    should_check = False
            except (ValueError, IOError):
                pass  # Invalid cache, will recheck

        if not should_check:
            return None

        # Perform check using git ls-remote (fast, no clone)
        repo_url = config.get('repo_url', '')
        if not repo_url:
            return None

        result = subprocess.run(
            ['git', 'ls-remote', '--tags', repo_url],
            capture_output=True,
            text=True,
            timeout=5
        )

        if result.returncode == 0:
            # Parse version tags (format: refs/tags/v2.1.0)
            tags = []
            for line in result.stdout.splitlines():
                if 'refs/tags/v' in line:
                    tag = line.split('refs/tags/')[1].strip()
                    # Remove leading 'v'
                    version = tag.lstrip('v')
                    tags.append(version)

            if tags:
                # Get latest version (sort semantically)
                latest = sorted(tags, key=lambda v: [int(x) for x in v.split('.')], reverse=True)[0]

                # Update cache
                cache_dir.mkdir(parents=True, exist_ok=True)
                cache_file.write_text(str(int(datetime.now(timezone.utc).timestamp())))
                (cache_dir / 'remote-version.txt').write_text(latest)

                # Compare with current version
                current = config.get('harness_version', '0.0.0')
                if latest != current:
                    return f"""
Harness update available!
   Current: v{current}
   Latest:  v{latest}

   Run /harness-pull to update
"""

        return None

    except subprocess.TimeoutExpired:
        # Network timeout - fail silently
        return None
    except Exception:
        # Any other error - fail silently
        return None

def main():
    """Main hook execution."""
    # Read hook input from stdin
    try:
        hook_input = json.loads(sys.stdin.read())
    except:
        hook_input = {}

    # Get project directory from environment
    project_dir = Path(os.environ.get('CLAUDE_PROJECT_DIR', '.')).resolve()
    state_dir = project_dir / '.claude-state'

    # Build context message from state files
    context_parts = []

    # Check harness version (NEW LOGIC)
    version_msg = check_harness_version(project_dir)
    if version_msg:
        context_parts.append(version_msg)

    # Load state files (EXISTING LOGIC)
    if state_dir.exists():
        state_files = {
            'session.yaml': 'Current Session',
            'preferences.yaml': 'User Preferences',
            'decisions.yaml': 'Decision History',
            'progress.yaml': 'Task Progress',
            'context.json': 'Project Context'
        }

        for filename, title in state_files.items():
            file_path = state_dir / filename
            if file_path.exists():
                content = file_path.read_text().strip()
                if content:
                    context_parts.append(f"## {title}\n```\n{content}\n```\n")

    # Build response
    if context_parts:
        message = "# Session State\n\n" + "\n".join(context_parts)
    else:
        message = "Starting new session."

    # Return response in correct format
    response = {
        "continue": True,
        "output": message
    }

    print(json.dumps(response))
    sys.exit(0)

if __name__ == "__main__":
    main()
