#!/usr/bin/env python3
# /// script
# requires-python = ">=3.9"
# dependencies = []
# ///

"""
Stop Hook
Runs when Claude Code session ends.
Updates session state with end timestamp.
"""

import json
import sys
import os
from pathlib import Path
from datetime import datetime

def main():
    # Read hook input
    try:
        hook_input = json.loads(sys.stdin.read())
    except:
        hook_input = {}

    # Get project directory
    project_dir = Path(os.environ.get('CLAUDE_PROJECT_DIR', '.')).resolve()
    state_dir = project_dir / '.claude-state'

    # Ensure state directory exists
    state_dir.mkdir(parents=True, exist_ok=True)

    # Update session file with end timestamp
    session_file = state_dir / 'session.yaml'
    timestamp = datetime.now().isoformat()

    if session_file.exists():
        content = session_file.read_text()
        if 'ended_at:' not in content:
            content += f"\nended_at: \"{timestamp}\"\n"
            session_file.write_text(content)

    # Log stop event
    stop_log = state_dir / 'last-session.json'
    stop_log.write_text(json.dumps({
        "ended_at": timestamp,
        "session_id": hook_input.get("session_id", "unknown")
    }, indent=2))

    # Return success
    response = {
        "continue": True
    }

    print(json.dumps(response))
    sys.exit(0)

if __name__ == "__main__":
    main()
