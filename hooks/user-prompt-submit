#!/usr/bin/env python3
# /// script
# requires-python = ">=3.9"
# dependencies = []
# ///

"""
UserPromptSubmit Hook
Runs before each user prompt.
Can inject relevant state based on keywords in the prompt.
"""

import json
import sys
import os
from pathlib import Path

def main():
    # Read hook input
    try:
        hook_input = json.loads(sys.stdin.read())
        # UserPromptSubmit hook receives the user's input
        user_input = hook_input.get('userInput', '') or hook_input.get('prompt', '')
    except:
        user_input = ''

    # Get project directory
    project_dir = Path(os.environ.get('CLAUDE_PROJECT_DIR', '.')).resolve()
    state_dir = project_dir / '.claude-state'

    # Check for keywords that should trigger state injection
    keywords = {
        'session': ['continue', 'resume', 'where were we', 'last', 'previous'],
        'preferences': ['prefer', 'style', 'convention', 'usually'],
        'decisions': ['decide', 'decided', 'choice', 'chose', 'why did'],
        'progress': ['progress', 'status', 'complete', 'done', 'task', 'todo']
    }

    user_lower = user_input.lower()
    relevant_files = []

    for state_file, trigger_words in keywords.items():
        if any(word in user_lower for word in trigger_words):
            file_path = state_dir / f"{state_file}.yaml"
            if file_path.exists():
                content = file_path.read_text().strip()
                if content:
                    relevant_files.append((state_file, content))

    # Build response
    if relevant_files:
        # Inject relevant state into context
        context = "## Relevant State\n\n"
        for name, content in relevant_files:
            context += f"### {name.capitalize()}\n```yaml\n{content}\n```\n\n"

        response = {
            "continue": True,
            "output": context
        }
    else:
        # No injection needed
        response = {
            "continue": True
        }

    print(json.dumps(response))
    sys.exit(0)

if __name__ == "__main__":
    main()
